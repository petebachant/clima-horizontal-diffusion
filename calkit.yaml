owner: petebachant
name: clima-horizontal-diffusion
title: CliMA horizontal diffusion
description: Optimizing performance of horizontal diffusion in ClimaAtmos.
git_repo_url: https://github.com/petebachant/clima-horizontal-diffusion
questions:
  - Why does horizontal diffusion slow down ClimaAtmos so much, and is there
    anything we can do about it?

environments:
  clima:
    kind: slurm
    host: clima.gps.caltech.edu
  py:
    path: requirements.txt
    kind: uv-venv
    prefix: .venv
    python: "3.13"

pipeline:
  stages:
    gen-smag-state:
      kind: sbatch
      environment: clima
      script_path: scripts/run.sh
      sbatch_options:
        - --gpus=1
        - --time=30
      args:
        - ClimaAtmos.jl/.buildkite
        - scripts/gen_smag_state.jl
      inputs:
        - scripts/gen_smag_state.jl
        - config/base.yml
        - config/smag.yml
        - ClimaAtmos.jl/src
        - ClimaAtmos.jl/toml
        - ClimaAtmos.jl/.buildkite/Manifest-v1.11.toml
      outputs:
        - path: results/smag_fixture.jld2
          storage: null
    nsys-baseline:
      kind: sbatch
      environment: clima
      script_path: scripts/run-nsys.sh
      sbatch_options:
        - --gpus=1
        - --time=60
      args:
        - results/nsys/baseline
        - ClimaAtmos.jl/.buildkite
        - config/base.yml
        - config/smag.yml
      inputs:
        - config/base.yml
        - config/smag.yml
        - ClimaAtmos.jl/src
        - ClimaAtmos.jl/toml
        - ClimaAtmos.jl/.buildkite/Manifest-v1.11.toml
        - ClimaAtmos.jl/perf/benchmark_step.jl
      outputs:
        - results/nsys/baseline.nsys-rep
    nsys-baseline-to-sqlite:
      kind: shell-command
      environment: _system
      command: nsys export results/nsys/baseline.nsys-rep -t sqlite
        -o results/nsys/baseline.sqlite
      inputs:
        - results/nsys/baseline.nsys-rep
      outputs:
        - results/nsys/baseline.sqlite
    nsys-mod:
      kind: sbatch
      environment: clima
      script_path: scripts/run-nsys.sh
      sbatch_options:
        - --gpus=1
        - --time=60
      args:
        - results/nsys/mod
        - ClimaAtmos.jl-mod/.buildkite
        - config/base.yml
        - config/smag.yml
      inputs:
        - config/base.yml
        - config/smag.yml
        - ClimaAtmos.jl-mod/src
        - ClimaAtmos.jl-mod/toml
        - ClimaAtmos.jl-mod/.buildkite/Manifest-v1.11.toml
        - ClimaAtmos.jl/perf/benchmark_step.jl
      outputs:
        - results/nsys/mod.nsys-rep
    nsys-mod-to-sqlite:
      kind: shell-command
      environment: _system
      command: nsys export results/nsys/mod.nsys-rep -t sqlite
        -o results/nsys/mod.sqlite
      inputs:
        - results/nsys/mod.nsys-rep
      outputs:
        - results/nsys/mod.sqlite
    summarize:
      kind: python-script
      environment: py
      script_path: scripts/summarize.py
      inputs:
        - results/nsys/baseline.sqlite
        - results/nsys/mod.sqlite
      outputs:
        - path: results/summary.json
          storage: git
